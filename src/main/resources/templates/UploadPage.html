<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta id="_csrf" name="_csrf" th:content="${_csrf.token}" />
	<link rel="stylesheet" th:href="@{/css/UploadPage.css}">
	<meta id="_csrf_header" name="_csrf_header" th:content="${_csrf.headerName}" />
	<script src="/js/dropzone.js"></script>
	<link rel="stylesheet" th:href="@{/css/dropzone.css}">
	<!-- <script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script> -->
	<!-- <link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" type="text/css" /> -->
	<script src="/js/jquery-3.6.0.min.js"></script>
	<script src="/js/popper.js"></script>
	<script type="text/map" src="/js/popper.js.map"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">

	<title>Document</title>
	<script th:inline="javascript">
		/* <![CDATA[ */
		const user_id = '[[${session.user_id}]]';
		let appliedTagList = [];
		window.onload = function () {
			if (user_id == 'null') {
				$('#logOption').html('log in');
			} else {
				$('#logSpan').html('');
				$('#nickname').html(user_id.substring(1, user_id.length - 1));
				$('#logOption').html('log out');
			}
		}

		function showAlert() {
			$('#alert').show()
			setTimeout(() => { $('#alert').fadeOut() }, 2500);
			return false;
		}

		function logAction() {
			const tagVal = $('#logOption').html();
			if (tagVal == 'log in') {
				$('#myModal').modal('show');
			} else {
				location.href = '/Account/logout';
			}
		}

		function clickTag(e) {
			if (e.className == 'btn btn-outline-info optionBtn') {
				e.className = 'btn btn-danger optionBtn'
			} else {
				e.className = 'btn btn-outline-info optionBtn'
			}
		}

		function addTag() {
			const taglist = $('#tegGrouprel');
			const regex = /^[ㄱ-ㅎ|가-힣|a-z| |A-Z|0-9|]+$/;
			let bl = document.querySelectorAll('#tegGrouprel > button');
			const newTag = document.querySelector('#newTagTextfield').value.trim();
			if (!regex.test(newTag)) {
				$('#errorMsg').html('한글영어 숫자만 써라');
				return showAlert();
			}

			for (elem of bl) {
				console.log(elem.innerHTML)
				if (elem.innerHTML == newTag) {
					$('#errorMsg').html('tag name overlap');
					return showAlert();
				}
			}
			let newBtnTag = `<button type="button" class="btn btn-outline-secondary optionBtn" onclick="this.remove()">${newTag}</button>`;
			taglist.append(newBtnTag);
			document.querySelector('#newTagTextfield').value = ''
		}

		function tagListRerender(field) {
			let tagListDiv = $('#tegGrouprel');
			let tagList = document.querySelectorAll('#tegGrouprel > button');
			const current_searchField_value = field.value

			if (current_searchField_value == '') {
				tagList.forEach(function (e) {
					e.style.display = 'block'
				})
				return;
			}

			for (elem of tagList) {
				if (!elem.innerHTML.includes(current_searchField_value)) {
					elem.style.display = 'none';
				} else {
					elem.style.display = 'block';
				}
			}

		}

		Dropzone.discover();
		Dropzone.options.myDropzone = {
			url: "http://localhost:8080/Pin/uploadPins",
			method: 'post',
			headers: {
				'X-CSRF-TOKEN': $('meta[name="token"]').attr('content'),
			},
			async: true,
			paramName: 'pins',
			clickable: true,
			autoQueue: true,
			autoProcessQueue: true,
			createImageThumbnails: true,
			thumbnailHeight: 120,
			thumbnailWidth: 120,
			maxFiles: 20,
			maxFilesize: 100,
			parallelUploads: 10,
			timeout: 1000 * 60,
			addRemoveLinks: false,
			acceptedFiles: '.jpeg, .jpg, .png, .JPEG, .JPG, .PNG,',
			params: {
				appliedTagList: appliedTagList,
			},
			init: function () {
				this.on('addedfiles', function () {
					let bl = document.querySelectorAll('#tegGrouprel > button');
					appliedTagList.length = 0;
					appliedTagList.push('$$empty$$')
					bl.forEach(function (elem) {
						if (elem.className == 'btn btn-danger optionBtn' || elem.className == 'btn btn-outline-secondary optionBtn') {
							appliedTagList.push(elem.innerHTML)
						}
					})
				})
			}
		}
		/* ]]> */
	</script>
	<th:block th:replace="~{fragments/navbar::logAction}"></th:block>
</head>

<body>
	<th:block th:replace="~{fragments/navbar::fragment-navbar}"></th:block>
	<img id="bg" src="../wefw.jpg" alt="hello">
	<img type="button" class="tagaddbtn" src="/plus.png" onclick="addTag()" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Tooltip on top"></img>
	<input type="text" id="newTagTextfield" onkeyPress="if(window.event.keyCode==13){ return addTag()}" placeholder="any tag?" maxlength=15 autofocus>
	<input type="text" id="searchTagTextfield" onkeyup="tagListRerender(this)" placeholder="search" maxlength=20>
	<form style="border-radius: 20px;" th:action="@{/Pin/uploadPins?__${_csrf.parameterName}__=__${_csrf.token}__}" class="dropzone container" id="myDropzone" enctype="multipart/form-data" method="post">
	</form>
	<div id="btnGroup">
		<div id="tegGrouprel">
			<th:block th:each="myTag, index: ${tagList}">
				<button type="button" class="btn btn-outline-info optionBtn" onclick="clickTag(this)" th:text="${myTag}"></button>
			</th:block>
		</div>
	</div>
	<div id="alert" role="alert" class="alert alert-danger alert-dismissable fade show fadeIn" style="display: none;" th:fragment="Alert-div">
		<svg id="svg" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2" viewBox="0 0 16 16" role="img" aria-label="Warning:">
			<path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
		</svg>
		<h4 style="text-align: left;">Notification</h4>
		<div id="errorMsg" style="text-align: left;"></div>
	</div>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
	<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
	<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
</body>

</html>