<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" th:href="@{/css/custom.css}">
	<link rel="stylesheet" th:href="@{/css/UserinfoSetting.css}">
	<script src="https://kit.fontawesome.com/67d8dfef5a.js" crossorigin="anonymous"></script>
	<script src="/js/jquery-3.6.0.min.js"></script>
	<script src="/js/popper.js"></script>
	<script src="/js/popper.js.map"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
	<script th:inline="javascript">
		/* <![CDATA[ */
		const user_id = '[[${session.user_id}]]';
		const user_email = '[[${email}]]';
		const reroad = '[[${reroad}]]';

		let apply, submit, image;
		let applyStatus = 'secondary';
		let profileForm;
		let commentList = '[[${commentList}]]'
		console.log(commentList)
		let commentJsonObjectList = JSON.parse(commentList)

		/* 로그인 여부를 검사하여 네비바의 로그인, 또는 로그아웃글자를 바꿔준다. 즉 네비바를 위한 함수이다. */

		function showAlert() {
			$('#alert').show()
			setTimeout(() => { $('#alert').fadeOut() }, 2500);
			return false;
		}

		function showAlert2() {
			$('#alert2').show()
			setTimeout(() => { $('#alert2').fadeOut() }, 2500);
			return false;
		}

		window.onload = function () {
			if (user_id == 'null') {
				$('#logOption').html('log in');
			} else {
				$('#nickname').html(user_id.substring(1, user_id.length - 1));
				$('#logOption').html('log out');
			}

			apply = document.getElementById('apply');
			submit = document.getElementById('profileBtn');
			image = document.getElementById('profileInput');
			profileForm = document.getElementById('profileForm');


			if (reroad == 1) {
				console.log(reroad);
				$('#successMsg').html('The changes have been applied.');
				showAlert2();
			}

			image.onchange = () => {
				if (image.value.length == 0) {
					if (applyStatus == 'secondary' || applyStatus == 'danger') {
						submit.disabled = true;
					} else if (applyStatus == 'success') {
						submit.disabled = false;
					}
				} else {
					if (applyStatus == 'danger') {
						submit.disabled = true;
					} else if (applyStatus == 'success' || applyStatus == 'secondary') {
						submit.disabled = false;
					}
				}
			};

			$("#email").on("propertychange change keyup paste input", function () {
				const change_email = $('#email').val();

				if (change_email == user_email.substring(1, user_email.length - 1)) {
					apply.className = 'btn btn-secondary';
					applyStatus = 'secondary';
					submit.disabled = false;
				} else {
					apply.className = 'btn btn-danger';
					applyStatus = 'danger';
					apply.disabled = false;
					submit.disabled = true;
				}
			});

			/* profileForm.addEventListener('submit', function (event) {
			}); */
			/* the brown fox jumps over the lazy dog. */

		}

		function commentListRerender(commentid) {
			let sign = 0;
			let removeIdx = 0;
			let think = $('#think');
			for (let idx in commentJsonObjectList) {
				console.log(commentJsonObjectList[idx].c_contents)
				if (commentJsonObjectList[idx].commentid == commentid) {
					sign = 1;
					$('div').remove('#' + commentid)
					removeIdx = idx;
					continue
				}
				if (sign == 1) {
					$('div').remove('#' + commentJsonObjectList[idx].commentid)
					think.append('<div id=\'' + commentJsonObjectList[idx].commentid + '\' class=\'card border-info row col-16 post shadow-lg p-1 mb-5 bg-body rounded fadeInCom\'> <div class=\'card-header\' style=\'text-align:left;font-family: \"Poor Story\", cursive; font-size: 20px;\' >' + commentJsonObjectList[idx].title + ' at ' + commentJsonObjectList[idx].c_time + '</div><div class=\'card-body\'> <img id=\'xbtn\' src=\'/delete.png\' onclick=\'deleteMyComment(' + commentJsonObjectList[idx].commentid + ')\' /><span >' + commentJsonObjectList[idx].c_contents + '</span></div></div>');
				}
			}
			commentJsonObjectList.splice(removeIdx, 1)
		}

		function checked_email_overlap() {
			const email = $('#email').val();
			const regEmail = /^[0-9a-zA-Z]([-_\.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_\.]?[0-9a-zA-Z])*\.[a-zA-Z]{2,3}$/;

			if (!regEmail.test(email)) {
				$('#errorMsg').html('wrong Email type');
				return showAlert();
			} else {
				$.ajax({
					type: "post",
					async: false,
					url: "http://localhost:8080/Account/checkEmail",
					data: { email: email },
					success: function (response) {
						if (response == 0) { // 변경성공
							apply.className = 'btn btn-success';
							applyStatus = 'success';
							apply.disabled = true;
							submit.disabled = false;
						} else if (response == 1) { // 변경 실패
							submit.disabled = true;
							$('#errorMsg').html('email exist already');
							return showAlert();
						}
						return false;
					},
					error: function (request, status, error) {
						alert("code: " + request.status + "message: " + request.responseText + "error: " + error);
					},
					complete: function (data, textStatus) { }
				});

			}
		}

		function deleteMyPost(postid) {
			console.log(postid)
		}

		function deleteMyComment(commentid) {
			$.ajax({
				type: "post",
				async: false,
				url: "http://localhost:8080/Comments/deleteComment",
				data: { commentid: commentid },
				success: function (response) {
					commentListRerender(commentid)
				},
				error: function (request, status, error) {
					alert("code: " + request.status + "message: " + request.responseText + "error: " + error);
				},
				complete: function (data, textStatus) { }
			});
		}
		/* ]]> */
	</script>
	<style>
		/* url('https://fonts.googleapis.com/css2?family=Mali:wght@300&display=swap'); */
		@import url('https://fonts.googleapis.com/css2?family=Poor+Story&display=swap');
	</style>
	<th:block th:replace="~{fragments/navbar.html::logAction}"></th:block>
</head>

<body>
	<th:block th:replace="~{fragments/navbar::fragment-navbar}"></th:block>
	<div id="index-nav" class="list-group">
		<a style="font-family: 'Poor Story', cursive; font-size: 19px;" class="list-group-item list-group-item-action" href="#profileForm">Email & Profile</a>
		<a style="font-family: 'Poor Story', cursive; font-size: 19px;" class="list-group-item list-group-item-action" href="#your_post">I wrote it</a>
		<a style="font-family: 'Poor Story', cursive; font-size: 19px;" class="list-group-item list-group-item-action" href="#your_like">I like it</a>
		<a style="font-family: 'Poor Story', cursive; font-size: 19px;" class="list-group-item list-group-item-action" href="#think">I have think about it</a>
		<a style="font-family: 'Poor Story', cursive; font-size: 19px;" class="list-group-item list-group-item-action" href="#tag">Tag Manager</a>
		<a style="font-family: 'Poor Story', cursive; font-size: 19px;" class="list-group-item list-group-item-action" href="#tagset">Tagset Manager</a>
	</div>
	<div class="container" id="scroll-div" data-bs-spy="scroll" data-bs-target="#index-nav" data-bs-offset="0" tabindex="0">
		<div class="card border-info row col-16" id="profileForm">
			<form id="profileForm" method="post" th:action="@{/Account/profile}" class="needs-validation card-body " enctype="multipart/form-data">
				<div class="input-group">
					<input id="email" type="text" name="email" required style="text-align: left" th:value="${email}" class="form-control" placeholder="Email" aria-label="Email" aria-describedby="button-addon2">
					<button onclick="checked_email_overlap()" disabled class="btn btn-secondary" type="button" id="apply">overLap check</button>
				</div><br>
				<input name="imagefile" class="form-control form-control-sm" id="profileInput" type="file" accept=".png, .jpg, .jpeg"><br>
				<button id="profileBtn" class="btn btn-primary float-right" th:type="submit">Apply</button>
			</form>
		</div><br>
		<div class="row col-16" id="your_post">
			<span class="badge text-bg-secondary" style="margin-top: 20px; margin-bottom: 20px; font-size: 20px; text-align: left;">I wrote it :) </span>
			<th:block th:each="mypost, index: ${IwroteitList}">
				<div class="card border-info row col-16 post shadow-lg p-1 mb-5 bg-body rounded">
					<div class="card-body">
						<img id="xbtn" src="/delete.png" th:onclick="deleteMyPost([[${mypost.postid}]])" />
						<span class="badge text-bg-warning" th:text="${mypost.postid}" /><br>
						<span th:text="${mypost.writtenTime}" style="font-family: 'Poor Story', cursive; font-size: 19px;" /><br>
						<a style="font-family: 'Poor Story', cursive; font-size: 19px;text-decoration-line : none;" th:text="${mypost.title}" th:href='@{/Post/PostViewer(postid=${mypost.postid})}' />
					</div>
				</div>
			</th:block>
		</div>
		<div class="row col-16" id="your_like">
			<span class="badge text-bg-secondary" style="margin-top: 20px; margin-bottom: 20px; font-size: 20px; text-align: left;">I like it :) </span>
			<div class="card border-info row col-16 post">
				<div class="card-body">
					test card body
				</div>
			</div>
			<div class="card border-info row col-16 post">
				<div class="card-body">
					test card body
				</div>
			</div>
			<div class="card border-info row col-16 post">
				<div class="card-body">
					test card body
				</div>
			</div>
			<div class="card border-info row col-16 post">
				<div class="card-body">
					test card body
				</div>
			</div>
		</div>
		<div class="row col-16" id="think">
			<span class="badge text-bg-secondary" style="margin-top: 20px; margin-bottom: 20px; font-size: 20px; text-align: left;">I comment it :) </span>
			<th:block th:each="mycomment, index: ${commentList}">
				<div th:id="${mycomment.commentid}" class="card border-info row col-16 post shadow-lg p-1 mb-5 bg-body rounded fadeInCom">
					<div class="card-header" style="text-align:left;font-family: 'Poor Story', cursive; font-size: 20px;" th:text="${mycomment.title} + ' at ' + ${mycomment.c_time}" />
					<div class="card-body">
						<img id="xbtn" src="/delete.png" th:onclick="deleteMyComment([[${mycomment.commentid}]])" />
						<span th:utext="${mycomment.c_contents}" />
					</div>
				</div>
			</th:block>
		</div>
	</div>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
	<div id="alert" role="alert" class="alert alert-danger alert-dismissable fade show fadeIn" style="display: none;" th:fragment="Alert-div">
		<svg id="svg" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2" viewBox="0 0 16 16" role="img" aria-label="Warning:">
			<path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
		</svg>
		<h4 style="text-align: left;">Notification</h4>
		<div id="errorMsg" style="text-align: left;"></div>
	</div>
	<div id="alert2" role="alert" class="alert alert-success alert-dismissable fade show fadeIn" style="display: none;" th:fragment="Alert-div">
		<img id="svg2" src="/check.svg" width="20" height="20">
		<h4 style="text-align: left;">Notification</h4>
		<div id="successMsg" style="text-align: left;"></div>
	</div>

</body>

</html>