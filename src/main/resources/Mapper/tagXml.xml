<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mappe 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.db.TagMapper">
	<insert id="insertTag" parameterType="java.util.List">
		insert into tag(pinName, tagName) 
		values 
			<foreach collection="list" item="item" separator=",">
			(
				#{item.pinName}, 
				#{item.tagName}
			)
			</foreach>
	</insert>

	<select id="findTagByUserid" parameterType="String" resultType="String">
		select distinct tagName 
		from tag 
		where pinName = some (
			select pinName 
			from Pin 
			where uploader = #{user_id});
	</select>

	<select id ="getTagCountList" parameterType="String" resultType="com.example.demo.db.TagCount">
		select tagName, count(pinName) as count 
		from ( select * from tag where pinName = some ( 
		select pinName from Pin where uploader = #{user_id})) subQuery 
		group by tagName
	</select>

	<delete id="deleteTagByUseridAndTagName" parameterType="hashMap">
		delete from tag 
		where tag.tagid = some ( 
			select tagid 
			from (select * from tag) tt inner join (select pinName from pin where uploader =#{map.user_id}) p 
			on p.pinName = tt.pinName 
			where tag.tagName = #{map.tagName}) 
	</delete>

	<update id="modifyTagName" parameterType="hashMap">
		update tag
		set tagName = #{map.ntn}
		where tag.tagid = some ( 
			select tagid 
			from (select * from tag) tt inner join (select pinName from pin where uploader =#{map.user_id}) p 
			on p.pinName = tt.pinName 
			where tag.tagName = #{map.otn}) 
	</update>

	<select id="getPininfoListByUploader" parameterType="String" resultType="com.example.demo.Service.PinInfoObject">
		select p.pinName, group_concat(tagName) as taglist, 
		avg(uploadDate) as uploadDate, avg(resolutionRatio) as resolutionRatio 
		from ( select * from tag ) tt right join (select * from pin where uploader = #{uploader} ) p 
		on tt.pinName = p.pinName  
		group by pinName;
	</select>
	
</mapper>



